version: 2.1

commands:
  install-package-dependencies:
    description: "Install package.json dependencies"
    steps:
      - run:
          command: npm install
  configure-aws:
    description: "Install dependencies for AWS and Serverless"
    steps:
      - run:
          command: sudo apt-get install python-dev python-pip
      - run:
          command: sudo pip install awscli
      - run:
          command: sudo npm i -g serverless
  create-dev-env:
    description: "Build dev env file"
    steps:
      - run:
          command: |
            echo "GITHUB_ACCESS_TOKEN_LINK=${GITHUB_ACCESS_TOKEN_LINK_DEV}" >> .env;
            echo "CLIENT_SECRET=${CLIENT_SECRET_DEV}" >> .env;
            echo "CLIENT_ID=${CLIENT_ID_DEV}" >> .env;
            echo "REDIRECT_URL=${REDIRECT_URL_DEV}" >> .env;
  create-prod-env:
    description: "Build prod env file"
    steps:
      - run:
          command: |
            echo "GITHUB_ACCESS_TOKEN_LINK=${GITHUB_ACCESS_TOKEN_LINK_PROD}" >> .env;
            echo "CLIENT_SECRET=${CLIENT_SECRET_PROD}" >> .env;
            echo "CLIENT_ID=${CLIENT_ID_PROD}" >> .env;
            echo "REDIRECT_URL=${REDIRECT_URL_PROD}" >> .env;
  deploy:
    description: "Serverless deploy development"
    steps:
      - run:
          command: sls deploy --stage ${STAGE}

jobs:
  build-production:
    working_directory: ~/noted
    docker:
      - image: circleci/node:carbon
    environment:
      - STAGE: prod
    steps:
      - checkout
      - install-package-dependencies
      - configure-aws
      - create-prod-env
      - deploy
  build-development:
    working_directory: ~/noted
    docker:
      - image: circleci/node:carbon
    environment:
      - STAGE: dev
    steps:
      - checkout
      - install-package-dependencies
      - configure-aws
      - create-dev-env
      - deploy

workflows:
  version: 2
  build-production:
    jobs:
      - build-production:
          filters:
            branches:
              only: master
  build-development:
    jobs:
      - build-development:
          filters:
            branches:
              only: development